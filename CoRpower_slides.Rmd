---
title: "R Package `CoRpower`: Power and Sample Size Calculations for Correlates of Risk"
subtitle: "Based on Gilbert, Janes, Huang (2016, *Stat Med*)"
author: "Michal Juraska"
date: "September 24-26, 2018"
output: 
  ioslides_presentation: 
    widescreen: true
    transition: 0
---

```{r, include=FALSE, cache=TRUE}
library(survival)
library(osDesign)
source("T:/vaccine/StephanieWu/CoR Power Package In Progress/CoRpower/Peter_CoRpower_trinaryMODIFIED.R")

figDir <- "T:/vaccine/StephanieWu/CoR Power Package In Progress/Figures"
```

## Outline
**Power and sample size calculations:**

1. **Without replacement sampling** for retrospective case-control or 2-phase designs
     + Trichotomous biomarker
         + Dichotomous biomarker
     + Continuous biomarker
2. **Bernoulli sampling** for prospective case-cohort designs

<br>
- All R code illustrated considering P2-VP8 rotavirus vaccine efficacy trial design

## Set-up and notation | Without replacement sampling
- Assume a randomized vaccine vs. placebo/control vaccine efficacy trial
- $N=$ number of vaccine recipients observed to be at risk at $\tau$
- $n_{cases}$ ($n_{controls}$) $=$ number of observed cases (controls) between $\tau$ and $\tau_{\mathrm{max}}$ with measured $S$ (or $S^{\ast}$), where cases have $\Delta Y = 1$ and controls have $\Delta (1-Y) = 1$

<br>
- If calculations done at design stage, then $N$, $n_{cases}$, and $n_{controls}$ projected numbers

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol>
<li> Specify overall $VE$ between $\tau$ and $\tau_{\mathrm{max}}$
  <ul>
  <li> Protocol-specified design alternative or $\widehat{VE}$
  </ul>
</li>
<li> Specify $risk_0$
  <ul>
  <li> Protocol-specified placebo-group endpoint rate or $\widehat{risk}_0$
  </ul>
</li>
<li> Select a grid of $VE^{lat}_0$ values
  <ul>
  <li> E.g., ranging from $VE$ ($H_0$) to 0 (maximal $H_1$ not allowing harm by vaccination)
  </ul>
</li>
<li> Select a grid of $VE^{lat}_1 \geq VE^{lat}_0$ values
  <ul>
  <li> E.g., $VE^{lat}_1 = VE$
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=5>
<li> Specify $P^{lat}_0$ and $P^{lat}_2$, then $P^{lat}_1 = 1-P^{lat}_0-P^{lat}_2$
  <ul>
  <li> Assuming $risk^{lat}_0(x) = risk_0$,
  \[
  VE = VE^{lat}_0 P^{lat}_0 + VE^{lat}_1 P^{lat}_1 + VE^{lat}_2 P^{lat}_2
  \]
  yields $VE^{lat}_2$
  <li> If $VE^{lat}_0$ varies from $VE$ to 0, then $VE^{lat}_2$ varies from VE to $VE\, (P^{lat}_0 + P^{lat}_2)/P^{lat}_2$
  </ul>
</li>
<li> Specify $P_0$ and $P_2$, then $P_1 = 1-P_0-P_2$
  <ul>
  <li> E.g., $P_0 = P^{lat}_0$ and $P_2 = P^{lat}_2$
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=7>
<li> **Approach 1:** Specify two of the three $(Sens, FP^0, FP^1)$ and two of the three $(Spec, FN^2, FN^1)$
  <ul>
  <li> E.g., specify $Sens$ and $Spec$ and $FP^0 = FN^2 = 0$
  </ul>

**Approach 2:** Specify $\sigma^2_{obs}$ and $\rho = \sigma^2_{tr} / \sigma^2_{obs}$ and determine $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ (next slides)
  <ul>
  <li> Typically, $\sigma^2_{obs} = 1$
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i">
<li> Assuming the classical measurement error model, where $X^{\ast} \sim \mathsf{N}(0,\rho\sigma^2_{obs})$, solve
\[
P^{lat}_0 = P(X^{\ast} \leq \theta_0) \quad \textrm{and} \quad P^{lat}_2 = P(X^{\ast} > \theta_2)
\]
for $\theta_0$ and $\theta_2$
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=2>
<li> Generate $M$ realizations of $X^{\ast}$ and $S^{\ast} = X^{\ast} + e$, where $e \sim \mathsf{N}(0,(1-\rho)\sigma^2_{obs})$, and $X^{\ast}$ independent of $e$
  <ul>
  <li> $M = 20000$ by default
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=3>
<li> Using $\theta_0$ and $\theta_2$ from Step i., define
\[
\begin{align}
Spec(\phi_0) &= P(S^{\ast} \leq \phi_0 \mid X^{\ast} \leq \theta_0)\\
FN^1(\phi_0) &= P(S^{\ast} \leq \phi_0 \mid X^{\ast} \in (\theta_0,\theta_2])\\
FN^2(\phi_0) &= P(S^{\ast} \leq \phi_0 \mid X^{\ast} > \theta_2)\\
Sens(\phi_2) &= P(S^{\ast} > \phi_2 \mid X^{\ast} > \theta_2)\\
FP^1(\phi_2) &= P(S^{\ast} > \phi_2 \mid X^{\ast} \in (\theta_0,\theta_2])\\
FP^0(\phi_2) &= P(S^{\ast} > \phi_2 \mid X^{\ast} \leq \theta_0)
\end{align}
\]
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=3>
<li> Estimate $Spec(\phi_0)$ by
\[
\widehat{Spec}(\phi_0) = \frac{\#\{S^{\ast}_m \leq \phi_0, X^{\ast}_m \leq \theta_0\}}{\#\{X^{\ast}_m \leq \theta_0\}}\,,
\]
etc.
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=4>
<li> Find $\phi_0 = \phi^{\ast}_0$ and $\phi_2 = \phi^{\ast}_2$ that numerically solve
\[
\begin{align}
P_0 &= \widehat{Spec}(\phi_0)P^{lat}_0 + \widehat{FN}^1(\phi_0)P^{lat}_1 + \widehat{FN}^2(\phi_0)P^{lat}_2\\
P_2 &= \widehat{Sens}(\phi_2)P^{lat}_2 + \widehat{FP}^1(\phi_2)P^{lat}_1 + \widehat{FP}^0(\phi_2)P^{lat}_0
\end{align}
\]
and compute
\[
Spec = \widehat{Spec}(\phi^{\ast}_0),\; Sens = \widehat{Sens}(\phi^{\ast}_2),\; \textrm{etc.}
\]
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
- In Approach 2, plot
\[
RR_t \quad \textrm{vs.} \quad RR^{lat}_2\big/ RR^{lat}_0,
\]
where
\[
RR_t = \frac{\sum_{x=0}^2 RR^{lat}_x P(X=x|S=2)}{\sum_{x=0}^2 RR^{lat}_x P(X=x|S=0)}
\]
- For $\rho < 1$, $RR_t$ closer to 1 than $RR^{lat}_2\big/ RR^{lat}_0$

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=8>
<li> Simulate $B$ data sets under the true parameter values
  <ol type="a">
  <li> $N_x = N \times P^{lat}_x$
  <li> $\left(n_{cases}(0),n_{cases}(1),n_{cases}(2)\right) \sim \mathsf{Mult}(n_{cases},(p_0,p_1,p_2))$, where $p_k=P(X=k|Y=1,Y^{\tau}=0,Z=1)$
  <li> For each of the $N_x$ subjects, generate $S_i$ by a draw from $\mathsf{Mult}(1,(p_0,p_1,p_2))$, where $p_k=P(S=k|X=x)$
  <li> Sample without replacement $n_{controls} = K n_{cases}$ controls, i.e., $n_{controls}(x)$ is a random variable for $x=0,1,2$
  </ol>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=9>
<li> For each data set, compute the 1-sided Wald test statistic for $H_0 \Leftrightarrow \widetilde{H}_0: \beta_S \geq 0$ from IPW logistic regression model that accounts for biomarker sampling design (function `tps` in R package `osDesign`)
<li> Compute power as proportion of data sets with 1-sided Wald test $p \leq \alpha/2$ for specified $\alpha$
<li> Repeat power calculation varying control:case ratio, $(P^{lat}_0, P^{lat}_2, P_0, P_2)$, $n_{cases}$, $(Sens, Spec)$, $\rho$
</ol>

## R package CoRpower: `computepower` function input parameters
- `numAtRiskTauCases`: number of vaccinees at risk at $\tau$ who become cases 
- `numAtRiskTauCasesPhase2`: number of vaccinees at risk at $\tau$ who become cases and have biomarker measured 
- `numAtRiskTauControls`: number of vaccinees at risk at $\tau$ who become controls 
- `risk0`: cumulative failure rate in placebo arm between month $\tau$ and $\tau_{max}$ 
- `RRoverall`: 1 minus the overall vaccine efficacy (overall relative risk of vaccinees vs. placebos) 
- `Plat0`: for trichotomous biomarker, probability true biomarker, X, belongs to the lowest latent subgroup
- `Plat2`: for trichotomous biomarker, probability true biomarker, X, belongs to the highest latent subgroup

## `computepower` input parameters (cont'd)
- `P0`: for trichotomous biomarker, probability observed biomarker, S, belongs to the lowest subgroup
- `P2`: for trichotomous biomarker, probability the observed biomarker, S, belongs to the highest subgroup
- `RRlat0`: for trichotomous biomarker, vector of relative risks of vaccinees vs. placebos for lowest latent subgroup
- `RRlat1`: for trichotomous biomarker, vector of relative risks of vaccinees vs. placebos for middle latent subgroup (assumed to be equal to `RRoverall`). For binary biomarker, can be left unspecified
- `biomType`: type of biomarker used. Default is "continuous"; other choices are "trichotomous" and "binary".
- `cohort`: sampling design used. Default is `FALSE`, specifying case-control sampling design. If `TRUE`, case-cohort sampling is used. 
- `p`: for case-cohort sampling design, probability that a subject will be in the cohort. 

## `computepower` input parameters (cont'd)
- `PlatVElowest`: for continuous biomarker, proportion of vaccine recipients with the lowest value of VE
- `VElowestvect`: for continuous biomarker, a vector of values corresponding to the lowest possible value of VE.  Typically, will range from 0 to 1 - `RRoverall`.
- `sigma2obs`: for continuous biomarker or trichotomous biomarker using approach 2, variance of the continuous observed biomarker, S*
- `rhos`: for continuous biomarker or trichotomous biomarker using approach 2, fraction of protection-relevant variability in the observed continuous biomarker
- `controlCaseRatio`: for case-control sampling design, number of controls sampled per case in the vaccine arm
- `Sens`: for trichotomous biomarker using approach 1, sensitivity of the measured biomarker, X. Specifying `Spec=NULL`, `FP0=NULL`, `Sens=NULL`, and `FN2=NULL` defaults to approach 2

## `computepower` input parameters (cont'd)
- `Spec`: for trichotomous biomarker using approach 1, specificity of the measured biomarker, X. 
- `FP0`: for trichotomous biomarker using approach 1, false positive rate of the observed biomarker when latent subgroup is 0 ($P(S=2|X=0)$). 
- `FN2`: for trichotomous biomarker using approach 1, false negative rate of the observed biomarker when latent subgroup is 2($P(S=0|X=2)$). 
- `M`: number of simulated clinical trials
- `alpha`: two-sided type-I error rate for CoR hypothesis tests
- `tpsMethod`: character denoting method for fitting the logistic regression model. Choose from "PL" for pseudo-likelihood (default), "ML" for maximum likelihood, and "WL" for weighted likelihood. 

## CoRpower input scenarios:
1. Trichotomous biomarker, Approach 1 ($Sens$, $Spec$, $FP^0$, $FN^2$ specified)
2. Trichotomous biomarker, Appraoch 2 ($\rho$, $\sigma^2_{obs}$ specified)
3. Continuous biomarker ($\rho$, $\sigma^2_{obs}$, $VE_{lowestvect}$, $P^{lat}_{VElowest}$ specified)

## 1. Trichotomous, Approach 1
###Scenario 1: Vary control:case ratio
<br>
<div style="float: left; width: 50%;">
- controlCaseRatio = 5:1, 3:1, 1:1
- $n_{cases} = 31$
- fraction of cases with biomarker measured = 1.0
- $n_{controls}=4485$
- $risk_0$ = 0.034
- $RR_{overall} = 0.25$
</div>
<div style="float: right; width: 50%;">
- $P^{lat}_0 = P_0 = 0.2$
- $P^{lat}_2 = P_2 = 0.6$
- $RR^{lat}_0 = 1 to 0.25$
- $RR^{lat}_1 = RR_{overall}$
- $sens = spec = 0.8$
- $FP^0 = FN^2 = 0$
</div>

## Scenario 1: Trichotomous, approach 1, vary control:case ratio {.smaller}
```{r, eval=FALSE}
library(CoRpower)
ans <- computepower(numAtRiskTauCases=31, 
                    numAtRiskTauCasesPhase2=31, 
                    numAtRiskTauControls=4485,
                    risk0=0.034, 
                    RRoverall=0.25, 
                    Plat0=0.2, P0=0.2, Plat2=0.6, P2=0.6, 
                    RRlat0=seq(1, 25, len=100), RRlat1=rep(0.25, 100), 
                    PlatVElowest=0, VElowestvect=NULL,  # specified for continuous biomarker only
                    controlCaseRatio=5*, 
                    M=1000, 
                    alpha=0.05, 
                    Spec=0.8, Sens=0.8, FP0=0 FN2=0, 
                    biomType="trichotomous", 
                    cohort=FALSE, p=NULL, 
                    tpsMethod= "PL")
```

*controlCaseRatio takes on 5, 3, and 1

## Output files

## Scenario 1 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen1.png"))
```

## 1. Trichotomous, Approach 1
###Scenario 2: Vary $P^{lat}_0, P_0, P^{lat}_2, P_2$ 

<div style="float: left; width: 50%;">
- $P^{lat}_0 = P_0 = 0.05, 0.1, 0.15, 0.2$
- $P^{lat}_2 = P_2 = 0.15, 0.3, 0.45, 0.6$
- $n_{cases} = 31$
- fraction of cases with biomarker measured = 1.0
- $n_{controls}=4485$
- $risk_0$ = 0.034
</div>
<div style="float: right; width: 50%;">
- controlCaseRatio = 5:1
- $RR_{overall} = 0.25$
- $RR^{lat}_0 = 1 to 0.25$
- $RR^{lat}_1 = RR_{overall}$
- $sens = spec = 0.8$
- $FP^0 = FN^2 = 0$
</div>

## Scenario 2: Trichotomous, approach 1, \(\small\, P^{lat}_0, P_0, P^{lat}_2, P_2\) {.smaller}
```{r, eval=FALSE}
ans <- computepower(numAtRiskTauCases=31, 
                    numAtRiskTauCasesPhase2=31, 
                    numAtRiskTauControls=4485,
                    risk0=0.034, 
                    RRoverall=0.25, 
                    Plat0=0.05*, P0=0.05*, Plat2=0.15*, P2=0.15*, 
                    RRlat0=seq(1, 25, len=100), RRlat1=rep(0.25, 100), 
                    PlatVElowest=0, VElowestvect=NULL,  # specified for continuous biomarker only
                    controlCaseRatio=5, 
                    M=1000, 
                    alpha=0.05, 
                    Spec=0.8, Sens=0.8, FP0=0 FN2=0, 
                    biomType="trichotomous", 
                    cohort=FALSE, p=NULL, 
                    tpsMethod= "PL")
```

*$P^{lat}_0$ and $P_0$ take on 0.05, 0.1, 0.15, and 0.2, and $P^{lat}_2$ and $P_2$ take on 0.15, 0.3, 0.45, and 0.6

## Scenario 2 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen2.png"))
```

## 1. Trichotomous, Approach 1
### Scenario 3: Vary $sens$ and $spec$ 

<div style="float: left; width: 50%;">
- $sens=spec = 1, 0.9, 0.8, 0.7$ 
- $n_{cases} = 31$
- fraction of cases with biomarker measured = 1.0
- $n_{controls}=4485$
- $risk_0$ = 0.034
- controlCaseRatio = 5:1
</div>
<div style="float: right; width: 50%;">
- $RR_{overall} = 0.25$
- $P^{lat}_0 = P_0 = 0.2$
- $P^{lat}_2 = P_2 = 0.6$
- $RR^{lat}_0 = 1 to 0.25$
- $RR^{lat}_1 = RR_{overall}$
- $FP^0 = FN^2 = 0$
</div>

## Scenario 3: Trichotomous, approach 1, vary \(\small\, sens, spec\) {.smaller}
```{r, eval=FALSE}
ans <- computepower(numAtRiskTauCases=31, 
                    numAtRiskTauCasesPhase2=31, 
                    numAtRiskTauControls=4485,
                    risk0=0.034, 
                    RRoverall=0.25, 
                    Plat0=0.2, P0=0.2, Plat2=0.6, P2=0.6, 
                    RRlat0=seq(1, 25, len=100), RRlat1=rep(0.25, 100), 
                    PlatVElowest=0, VElowestvect=NULL,
                    controlCaseRatio=5, 
                    M=1000, 
                    alpha=0.05, 
                    Spec=1*, Sens=1*, FP0=0 FN2=0, 
                    biomType="trichotomous", 
                    cohort=FALSE, p=NULL, 
                    tpsMethod= "PL")
```

*$sens$ and $spec$ take on 1, 0.9, 0.8, and 0.7

## Scenario 3 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen3.png"))
```
