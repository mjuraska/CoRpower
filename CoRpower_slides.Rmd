---
title: "R Package `CoRpower`: Power and Sample Size Calculations for Correlates of Risk"
subtitle: "Based on Gilbert, Janes, Huang (2016, *Stat Med*)"
author: "Michal Juraska"
date: "September 24--26, 2018"
output: 
  ioslides_presentation: 
    widescreen: true
    transition: 0
---

```{r, include=FALSE, cache=TRUE}
library(survival)
library(osDesign)
source("T:/vaccine/StephanieWu/CoR Power Package In Progress/CoRpower/Peter_CoRpower_trinaryMODIFIED.R")

figDir <- "T:/vaccine/StephanieWu/CoR Power Package In Progress/Figures"
```

## Outline
### **Power calculations**

1. **Without replacement sampling** for retrospective case-control or 2-phase designs
     + Trichotomous biomarker
         + Dichotomous biomarker
     + Continuous biomarker
2. **Bernoulli sampling** for prospective case-cohort designs

<!-- <br>  -->
<!-- - All R code illustrated considering P2-VP8 rotavirus vaccine efficacy trial design  -->

## Set-up and notation | Without replacement sampling
- Assume a randomized vaccine vs. placebo/control vaccine efficacy trial
- $N=$ number of vaccine recipients observed to be at risk at $\tau$
- $n_{cases}$ ($n_{controls}$) $=$ number of observed cases (controls) between $\tau$ and $\tau_{\mathrm{max}}$, where cases have $\Delta Y = 1$ and controls have $\Delta (1-Y) = 1$
    - $n_{cases} + n_{controls} \leq N$
- $n^S_{cases}$ ($n^S_{controls}$) $=$ number of observed cases (controls) between $\tau$ and $\tau_{\mathrm{max}}$ with measured $S$ (or $S^{\ast}$)

<br>
- If calculations done at design stage, then $N$, $n_{cases}$, $n_{controls}$, $n^S_{cases}$, and $n^S_{controls}$ projected numbers

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol>
<li> Specify overall $VE$ between $\tau$ and $\tau_{\mathrm{max}}$
  <ul>
  <li> Protocol-specified design alternative or $\widehat{VE}$
  </ul>
</li>
<li> Specify $risk_0$
  <ul>
  <li> Protocol-specified placebo-group endpoint rate or $\widehat{risk}_0$
  </ul>
</li>
<li> Select a grid of $VE^{lat}_0$ values
  <ul>
  <li> E.g., ranging from $VE$ ($H_0$) to 0 (maximal $H_1$ not allowing harm by vaccination)
  </ul>
</li>
<li> Select a grid of $VE^{lat}_1 \geq VE^{lat}_0$ values
  <ul>
  <li> E.g., $VE^{lat}_1 = VE$
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=5>
<li> Specify $P^{lat}_0$ and $P^{lat}_2$, then $P^{lat}_1 = 1-P^{lat}_0-P^{lat}_2$
  <ul>
  <li> Assuming $risk^{lat}_0(x) = risk_0$,
  \[
  VE = VE^{lat}_0 P^{lat}_0 + VE^{lat}_1 P^{lat}_1 + VE^{lat}_2 P^{lat}_2
  \]
  yields $VE^{lat}_2$
  <li> If $VE^{lat}_0$ varies from $VE$ to 0, then $VE^{lat}_2$ varies from VE to $VE\, (P^{lat}_0 + P^{lat}_2)/P^{lat}_2$
  </ul>
</li>
<li> Specify $P_0$ and $P_2$, then $P_1 = 1-P_0-P_2$
  <ul>
  <li> E.g., $P_0 = P^{lat}_0$ and $P_2 = P^{lat}_2$
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=7>
<li> **Approach 1:** Specify two of the three $(Sens, FP^0, FP^1)$ and two of the three $(Spec, FN^2, FN^1)$
  <ul>
  <li> E.g., specify $Sens$ and $Spec$ and $FP^0 = FN^2 = 0$
  </ul>

**Approach 2:** Specify $\sigma^2_{obs}$ and $\rho = \sigma^2_{tr} / \sigma^2_{obs}$ and determine $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ (subsequent slides)
  <ul>
  <li> Typically, $\sigma^2_{obs} = 1$
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i">
<li> Assuming the classical measurement error model, where $X^{\ast} \sim \mathsf{N}(0,\rho\sigma^2_{obs})$, solve
\[
P^{lat}_0 = P(X^{\ast} \leq \theta_0) \quad \textrm{and} \quad P^{lat}_2 = P(X^{\ast} > \theta_2)
\]
for $\theta_0$ and $\theta_2$
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=2>
<li> Generate $B$ realizations of $X^{\ast}$ and $S^{\ast} = X^{\ast} + e$, where $e \sim \mathsf{N}(0,(1-\rho)\sigma^2_{obs})$, and $X^{\ast}$ independent of $e$
  <ul>
  <li> $B = 20000$ by default
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=3>
<li> Using $\theta_0$ and $\theta_2$ from Step i., define
\[
\begin{align}
Spec(\phi_0) &= P(S^{\ast} \leq \phi_0 \mid X^{\ast} \leq \theta_0)\\
FN^1(\phi_0) &= P(S^{\ast} \leq \phi_0 \mid X^{\ast} \in (\theta_0,\theta_2])\\
FN^2(\phi_0) &= P(S^{\ast} \leq \phi_0 \mid X^{\ast} > \theta_2)\\
Sens(\phi_2) &= P(S^{\ast} > \phi_2 \mid X^{\ast} > \theta_2)\\
FP^1(\phi_2) &= P(S^{\ast} > \phi_2 \mid X^{\ast} \in (\theta_0,\theta_2])\\
FP^0(\phi_2) &= P(S^{\ast} > \phi_2 \mid X^{\ast} \leq \theta_0)
\end{align}
\]
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=3>
<li> Estimate $Spec(\phi_0)$ by
\[
\widehat{Spec}(\phi_0) = \frac{\#\{S^{\ast}_b \leq \phi_0, X^{\ast}_b \leq \theta_0\}}{\#\{X^{\ast}_b \leq \theta_0\}}\,,
\]
etc.
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=4>
<li> Find $\phi_0 = \phi^{\ast}_0$ and $\phi_2 = \phi^{\ast}_2$ that numerically solve
\[
\begin{align}
P_0 &= \widehat{Spec}(\phi_0)P^{lat}_0 + \widehat{FN}^1(\phi_0)P^{lat}_1 + \widehat{FN}^2(\phi_0)P^{lat}_2\\
P_2 &= \widehat{Sens}(\phi_2)P^{lat}_2 + \widehat{FP}^1(\phi_2)P^{lat}_1 + \widehat{FP}^0(\phi_2)P^{lat}_0
\end{align}
\]
and compute
\[
Spec = \widehat{Spec}(\phi^{\ast}_0),\; Sens = \widehat{Sens}(\phi^{\ast}_2),\; \textrm{etc.}
\]
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
- In Approach 2, plot
\[
RR_t \quad \textrm{vs.} \quad RR^{lat}_2\big/ RR^{lat}_0,
\]
where
\[
RR_t = \frac{\sum_{x=0}^2 RR^{lat}_x P(X=x|S=2)}{\sum_{x=0}^2 RR^{lat}_x P(X=x|S=0)}
\]
- For $\rho < 1$, $RR_t$ closer to 1 than $RR^{lat}_2\big/ RR^{lat}_0$

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=8>
<li> Simulate $M$ data sets under the true parameter values:
  <ol type="a">
  *Full data*
  <li> $N_x = (n_{controls} + n_{cases}) P^{lat}_x$
  <li> $\left(n_{cases}(0),n_{cases}(1),n_{cases}(2)\right) \sim \mathsf{Mult}(n_{cases},(p_0,p_1,p_2))$, where $p_k=P(X=k|Y=1,Y^{\tau}=0,Z=1)$
  <li> For each of the $N_x$ subjects, generate $S_i$ by a draw from $\mathsf{Mult}(1,(p_0,p_1,p_2))$, where $p_k=P(S=k|X=x)$ </li>
  *Observed data*
  <li> Sample without replacement $n^S_{cases}$ and $n^S_{controls} = K n^S_{cases}$ controls with measured $S$ $(R=1)$, i.e., the control:case ratio is not fixed within subgroup $X=x$
  </ol>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=9>
<li> For each observed data set, compute the 1-sided one-degree-of-freedom Wald test statistic for $H_0 \Leftrightarrow \{\widetilde{H}_0: \beta_S \geq 0\}$ from IPW logistic regression model that accounts for biomarker sampling design (function `tps` in R package `osDesign`)
  <ul>
  <li> Alternatively, use the generalized two-degree-of-freedom Wald test
  </ul>
</li>
<li> Compute power as proportion of data sets with 1-sided Wald test $p \leq \alpha/2$ for specified $\alpha$
<li> Repeat power calculation varying control:case ratio, $n_{cases}$, $n^S_{cases}$, $(P^{lat}_0, P^{lat}_2, P_0, P_2)$, $(Sens, Spec)$, $\rho$
</ol>

## Illustration: hypothetical randomized placebo-controlled VE trial
### **Trial design**
- $N_{rand} = 4,100$ participants randomized to each of the vaccine and placebo group and followed for $\tau_{\mathrm{max}}=$ 24 months
- Samples for measurement of $S$ at $\tau=$ 3.5 months stored in all vaccine recipients
- Cumulative endpoint rate between $\tau$ and $\tau_{\mathrm{max}}$ in placebo group $=3.4\%$ $(=risk_0)$
- $VE_{\tau-\tau_{\mathrm{max}}}=75\%$, $\quad VE_{0-\tau}=VE_{\tau-\tau_{\mathrm{max}}}/2$
- Cumulative dropout rate between 0 and $\tau_{\mathrm{max}}=10\%$

## Illustration: calculation of input parameters
Assuming the standard survival analysis framework,

- $N = N_{rand} \times P(T>\tau, C>\tau \mid Z=1) \approx 4,023$
- $n_{cases} = N \times P(T\leq \tau_{\mathrm{max}}, T\leq C \mid T>\tau, C>\tau, Z=1) \approx 32$
- $n_{ontrols} = N \times P(T > \tau_{\mathrm{max}}, C > \tau_{\mathrm{max}} \mid T>\tau, C>\tau, Z=1) \approx 3,585$
- $n^S_{cases} = n_{cases}$
- $n^S_{controls} = K n^S_{cases}$

## Illustration: `CoRpower` for trichotomous \(\small\, S\) | Without replacement sampling
**Approach 1** $(Sens, Spec, FP^0, FN^2$ specified$)$

- *Scenario 1:* vary control:case ratio
- *Scenario 2:* vary $Sens$, $Spec$
- *Scenario 3:* vary $P_0^{lat}$, $P_2^{lat}$, $P_0$, $P_2$

**Approach 2** $(\sigma^2_{obs}$ and $\rho$ specified$)$

- *Scenario 4:* vary $\rho$
- *Scenario 5:* vary $P_0^{lat}$, $P_2^{lat}$, $P_0$, $P_2$
- *Scenario 6:* vary $n_{cases}$

## *Scenario 1:* vary control:case ratio (Approach 1) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
library(CoRpower)
pwr <- computePower(nAtRiskTauCases = 32,                # n_cases
                    nAtRiskTauControls = 3585,           # n_controls
                    nAtRiskTauCasesPhase2 = 32,          # n^S_cases
                    controlCaseRatio = 5,                # scalar, i.e., separate calls for 5, 3, 1
                    VEoverall = 0.75,                    # overall VE
                    risk0 = 0.034,                       # cumulative placebo risk between tau and tau_max 
                    VElat0 = seq(0, VEoverall, len=100), # grid of VE (V/P) among lower protected
                    VElat1 = rep(VEoverall, 100),        # grid of VE (V/P) among medium protected
                    Plat0 = 0.2,                         # prevalence of lower protected
                    Plat2 = 0.6,                         # prevalence of higher protected
                    P0 = 0.2,                            # probability of low biomarker response
                    P2 = 0.6,                            # probability of high biomarker response
                    sens = 0.8, spec = 0.8, FP0 = 0, FN2 = 0,
                    M = 1000,                            # number of simulated clinical trials
                    alpha = 0.05,                        # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")           # "continuous" by default
```

```{r, include=FALSE, cache=TRUE}
setwd("T:/vaccine/StephanieWu/CoR Power Package In Progress/Scenario1/K3")
load("ansScen1.RData")
```

## *Scenario 1:* vary control:case ratio (Approach 1) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
Output list for `controlCaseRatio = 5`:
```{r}
pwr$power[1, c(1, 25, 50, 75, 100)]
pwr$RRt[1, c(1, 25, 50, 75, 100)]
pwr$VElat2[c(1, 25, 50, 75, 100)]
```
Other components: `risk1_2`, `risk1_0`, `VElat0`, `Plat2`, `Plat0`, `P2`, `P0`, `alphaLat`, `betaLat`, `sens`, `spec`, `FP0`, `FN2`, `rho`, `N`, `nCases`, `nCasesPhase2`, `controlCaseRatio`, `VEoverall`, `alpha`, 

## *Scenario 1:* vary control:case ratio (Approach 1) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
### Plotting of power curves
```{r, eval=FALSE}
plotPowerTrinary(outComputePower = list(pwr5to1, pwr3to1, pwr1to1),    # output lists from 'computePower'
                 legendText = paste0("Control:Case = ", c("5:1", "3:1", "1:1")))
```

Alternatively,
```{r, eval=FALSE}
computePower(..., saveDir = "myDir", saveFile = "myFile.RData")
plotPowerTrinary(outComputePower = c("myFile1", "myFile2", "myFile3"), # files with 'computePower' output
                 outDir = rep("~/myDir", 3),                           # path to each myFilex.RData
                 legendText = paste0("Control:Case = ", c("5:1", "3:1", "1:1")))
```

## *Scenario 1:* vary control:case ratio (Approach 1)
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen1.png"))
```

## *Scenario 2:* vary \(\small\, Sens\) and \(\small\, Spec\) (Approach 1) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = 32,                # n_cases
                    nAtRiskTauControls = 3585,           # n_controls
                    nAtRiskTauCasesPhase2 = 32,          # n^S_cases
                    controlCaseRatio = 5,                # n^S_controls : n^S_cases ratio
                    VEoverall = 0.75,                    # overall VE
                    risk0 = 0.034,                       # cumulative placebo risk between tau and tau_max 
                    VElat0 = seq(0, VEoverall, len=100), # grid of VE (V/P) among lower protected
                    VElat1 = rep(VEoverall, 100),        # grid of VE (V/P) among medium protected
                    Plat0 = 0.2,                         # prevalence of lower protected
                    Plat2 = 0.6,                         # prevalence of higher protected
                    P0 = 0.2,                            # probability of low biomarker response
                    P2 = 0.6,                            # probability of high biomarker response
                    sens = c(1, 0.9, 0.8, 0.7), spec = c(1, 0.9, 0.8, 0.7), 
                    FP0 = 0, FN2 = 0,
                    M = 1000,                            # number of simulated clinical trials
                    alpha = 0.05,                        # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")           # "continuous" by default
```

## *Scenario 2:* vary \(\small\, Sens\) and \(\small\, Spec\) (Approach 1)
```{r, echo=FALSE, fig.align='center', out.width='67%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen3.png"))
```

## *Scenario 3:* vary \(\small\, P^{lat}_0, P^{lat}_2, P_0, P_2\) (Approach 1) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = 32,                # n_cases
                    nAtRiskTauControls = 3585,           # n_controls
                    nAtRiskTauCasesPhase2 = 32,          # n^S_cases
                    controlCaseRatio = 5,                # n^S_controls : n^S_cases ratio
                    VEoverall = 0.75,                    # overall VE
                    risk0 = 0.034,                       # cumulative placebo risk between tau and tau_max 
                    VElat0 = seq(0, VEoverall, len=100), # grid of VE (V/P) among lower protected
                    VElat1 = rep(VEoverall, 100),        # grid of VE (V/P) among medium protected
                    Plat0 = 0.05,                        # scalar, ie separate calls for 0.05, 0.1, 0.15, 0.2
                    Plat2 = 0.15,                        # scalar, ie separate calls for 0.15, 0.3, 0.45, 0.6
                    P0 = 0.05,                           # scalar, ie separate calls for 0.05, 0.1, 0.15, 0.2
                    P2 = 0.15,                           # scalar, ie separate calls for 0.15, 0.3, 0.45, 0.6
                    sens = 0.8, spec = 0.8, FP0 = 0, FN2 = 0,
                    M = 1000,                            # number of simulated clinical trials
                    alpha = 0.05,                        # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")           # "continuous" by default
```

## *Scenario 3:* vary \(\small\, P^{lat}_0, P^{lat}_2, P_0, P_2\) (Approach 1)
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen2.png"))
```

## *Scenario 4:* vary \(\small\, \rho \) (Approach 2) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = 32,                # n_cases
                    nAtRiskTauControls = 3585,           # n_controls
                    nAtRiskTauCasesPhase2 = 32,          # n^S_cases
                    controlCaseRatio = 5,                # n^S_controls : n^S_cases ratio
                    VEoverall = 0.75,                    # overall VE
                    risk0 = 0.034,                       # cumulative placebo risk between tau and tau_max 
                    VElat0 = seq(0, VEoverall, len=100), # grid of VE (V/P) among lower protected
                    VElat1 = rep(VEoverall, 100),        # grid of VE (V/P) among medium protected
                    Plat0 = 0.2,                         # prevalence of lower protected
                    Plat2 = 0.6,                         # prevalence of higher protected
                    P0 = 0.2,                            # probability of low biomarker response
                    P2 = 0.6,                            # probability of high biomarker response
                    sigma2obs = 1,                       # variance of observed biomarker S
                    rho = c(1, 0.9, 0.7, 0.5),           # protection-relevant fraction of the variance of S
                    M = 1000,                            # number of simulated clinical trials
                    alpha = 0.05,                        # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")           # "continuous" by default
```

## *Scenario 4:* vary \(\small\, \rho \) (Approach 2) | Trichotomous \(\small\, S\), without replacement sampling
```{r, echo=FALSE, fig.align='center', out.width='90%'}
knitr::include_graphics(file.path(figDir,"Scen5Table1.png"))
```

## *Scenario 4:* vary \(\small\, \rho \) (Approach 2)
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen5.png"))
```

## *Scenario 4:* vary \(\small\, \rho \) (Approach 2) {.smaller}
```{r, eval=FALSE}
plotRRcomparison(dataDir = "~/Scen4",                   # input directory 
                 dataFile = "pwr",                      # input file (.RData file)
                 variableName = "rho",                  # name of varying parameter
                 variableValues = c(1, 0.9, 0.7, 0.5),  # values of varying parameter
                 legendText=NULL)                       # option to specify legend text
```

## *Scenario 4:* vary \(\small\, \rho \) (Approach 2)
```{r, echo=FALSE, fig.align='center', out.width='70%'}
knitr::include_graphics(file.path(figDir,"RRcomparison_CoR_Scen5.png"))
```

## *Scenario 5:* vary \(\small\, P^{lat}_0, P_0, P^{lat}_2, P_2 \) (Approach 2) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = 32,                # n_cases
                    nAtRiskTauControls = 3585,           # n_controls
                    nAtRiskTauCasesPhase2 = 32,          # n^S_cases
                    controlCaseRatio = 5,                # n^S_controls : n^S_cases ratio
                    VEoverall = 0.75,                    # overall VE
                    risk0 = 0.034,                       # cumulative placebo risk between tau and tau_max 
                    VElat0 = seq(0, VEoverall, len=100), # grid of VE (V/P) among lower protected
                    VElat1 = rep(VEoverall, 100),        # grid of VE (V/P) among medium protected
                    Plat0 = 0.05,                        # scalar, ie separate calls for 0.05, 0.1, 0.15, 0.2
                    Plat2 = 0.15,                        # scalar, ie separate calls for 0.15, 0.3, 0.45, 0.6
                    P0 = 0.05,                           # scalar, ie separate calls for 0.05, 0.1, 0.15, 0.2
                    P2 = 0.15,                           # scalar, ie separate calls for 0.15, 0.3, 0.45, 0.6
                    sigma2obs = 1,                       # variance of observed biomarker S
                    rho = 0.9,                           # protection-relevant fraction of the variance of S
                    M = 1000,                            # number of simulated clinical trials
                    alpha = 0.05,                        # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")           # "continuous" by default
```

## *Scenario 5:* vary \(\small\, P^{lat}_0, P_0, P^{lat}_2, P_2 \) (Approach 2) | Trichotomous \(\small\, S\), without replacement sampling
```{r, echo=FALSE, fig.align='center', out.width='90%', out.height='30%'}
knitr::include_graphics(file.path(figDir,"Scen6Table1.png"))
```

## *Scenario 5:* vary \(\small\, P^{lat}_0, P_0, P^{lat}_2, P_2 \) (Approach 2)
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen6.png"))
```

## *Scenario 6:* vary \(\small\, n_{cases}\) (Approach 2) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = c(25, 32, 35, 40),            # n_cases
                    nAtRiskTauControls = c(3998, 3585, 3988, 3983), # n_controls
                    nAtRiskTauCasesPhase2 = c(25, 32, 35, 40),      # n^S_cases
                    controlCaseRatio = 5,                           # n^S_controls : n^S_cases ratio
                    VEoverall = 0.75,                    # overall VE
                    risk0 = 0.034,                       # cumulative placebo risk between tau and tau_max 
                    VElat0 = seq(0, VEoverall, len=100), # grid of VE (V/P) among lower protected
                    VElat1 = rep(VEoverall, 100),        # grid of VE (V/P) among medium protected
                    Plat0 = 0.2,                         # prevalence of lower protected
                    Plat2 = 0.6,                         # prevalence of higher protected
                    P0 = 0.2,                            # probability of low biomarker response
                    P2 = 0.6,                            # probability of high biomarker response
                    sigma2obs = 1,                       # variance of observed biomarker S
                    rho = 0.9,                           # protection-relevant fraction of the variance of S
                    M = 1000,                            # number of simulated clinical trials
                    alpha = 0.05,                        # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")           # "continuous" by default
```

## *Scenario 6:* vary \(\small\, n_{cases}\) (Approach 2) | Trichotomous \(\small\, S\), without replacement sampling
```{r, echo=FALSE, fig.align='center', out.width='90%'}
knitr::include_graphics(file.path(figDir,"Scen7Table1.png"))
```

## *Scenario 6:* vary \(\small\, n_{cases}\) (Approach 2) 
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen7.png"))
```

## Illustration: `CoRpower` for binary \(\small\, S\) | Without replacement sampling
Achieved by selecting $P_0^{lat}$, $P_2^{lat}$, $P_0$, $P_2$ such that
\[
\begin{align}
P_0^{lat} + P_2^{lat} &= 1\\
P_0 + P_2 &= 1
\end{align}
\]

<br>
**Approach 2** $(\sigma^2_{obs}$ and $\rho$ specified$)$

- *Scenario 7:* vary $n_{cases}$

## *Scenario 7:* vary \(\small\, n_{cases}\) (Approach 2) | Binary \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = c(25, 32, 35, 40),            # n_cases
                    nAtRiskTauControls = c(3998, 3585, 3988, 3983), # n_controls
                    nAtRiskTauCasesPhase2 = c(25, 32, 35, 40),      # n^S_cases
                    controlCaseRatio = 5,                           # n^S_controls : n^S_cases ratio
                    VEoverall = 0.75,                    # overall VE
                    risk0 = 0.034,                       # cumulative placebo risk between tau and tau_max 
                    VElat0 = seq(0, VEoverall, len=100), # grid of VE (V/P) among lower protected
                    VElat1 = rep(VEoverall, 100),        # grid of VE (V/P) among medium protected
                    Plat0 = 0.2,                         # prevalence of lower protected
                    Plat2 = 0.8,                         # prevalence of higher protected
                    P0 = 0.2,                            # probability of low biomarker response
                    P2 = 0.8,                            # probability of high biomarker response
                    sigma2obs = 1,                       # variance of observed biomarker S
                    rho = 0.9,                           # protection-relevant fraction of the variance of S
                    M = 1000,                            # number of simulated clinical trials
                    alpha = 0.05,                        # two-sided Wald test Type 1 error rate
                    biomType = "binary")                 # "continuous" by default
```

## *Scenario 7:* vary \(\small\, n_{cases}\) (Approach 2) | Binary \(\small\, S\), without replacement sampling
```{r, echo=FALSE, fig.align='center', out.width='90%'}
knitr::include_graphics(file.path(figDir,"Scen8Table1.png"))
```

## *Scenario 7:* vary \(\small\, n_{cases}\) (Approach 2)
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen8.png"))
```

## Algorithm for continuous biomarker \(\small\, S^{\ast}\) | Without replacement sampling
<ol>
<li> Specify overall $VE$ between $\tau$ and $\tau_{\mathrm{max}}$
  <ul>
  <li> Protocol-specified design alternative or $\widehat{VE}$
  </ul>
</li>
<li> Specify $risk_0$
  <ul>
  <li> Protocol-specified placebo-group endpoint rate or $\widehat{risk}_0$
  </ul>
</li>
</ol>

## Algorithm for continuous biomarker \(\small\, S^{\ast}\) | Without replacement sampling
<ol start=3>
<li> Specify $P^{lat}_{lowestVE}$, $\rho$, and a grid of $VE_{lowest}$ values (e.g., ranging from $VE$ to 0)
  <ul>
  <li> Fixed $(VE, risk_0, P^{lat}_{lowestVE}, VE_{lowest}, \rho)$ and
  \[
  \begin{align}
  risk^{lat}_1(x^{\ast}) &= (1 - VE_{lowest}) risk_0,\quad x^{\ast} \leq \nu\\
  \mathop{\mathrm{logit}}\{risk^{lat}_1(x^{\ast})\} &= \alpha^{lat}+\beta^{lat}x^{\ast},\quad x^{\ast} \geq \nu\\
  VE &= 1 - \frac{\int risk^{lat}_1(x^{\ast})\phi(x^{\ast}/\sqrt{\rho} \sigma_{obs})\mathop{\mathrm{d}}\!x^{\ast}}{risk_0}
  \end{align}
  \]
  yield $\alpha^{lat}$ and $\beta^{lat}$
  <li> Plot $VE^{lat}_{x^{\ast}}$ vs. $x^{\ast}$ and calculate the pertaining CoR effect size $\exp(\beta^{lat})$ for each level of $VE_{lowest}$
  </ul>
</li>
</ol>

## Algorithm for continuous biomarker \(\small\, S^{\ast}\) | Without replacement sampling
<ol start=4>
<li> Simulate $M$ data sets under the true parameter values:
  <ol type="a">
  *Full data*
  <li> Sample $X^{\ast}$ for $n_{cases}$ cases from $f_{X^{\ast}}(x^{\ast}|Y=1,Y^{\tau}=0,Z=1)$ using Bayes rule
  <li> Sample $X^{\ast}$ for $n_{controls}$ controls from $f_{X^{\ast}}(x^{\ast}|Y=0,Y^{\tau}=0,Z=1)$ using Bayes rule
  <br>
  - How? Use a fine grid of $\widetilde{x}^{\ast}$ values and then 
  <br>
  $\;\;$`sample(`$\widetilde{x}^{\ast}$, `prob=`$f_{X^{\ast}}(\widetilde{x}^{\ast}|Y=\cdot,Y^{\tau}=0,Z=1)$, `replace=TRUE)`
  <li> Sample $S^{\ast}$ following $S^{\ast} = X^{\ast} + e$ </li>
  *Observed data*
  <li> Sample without replacement $n^S_{cases}$ and $n^S_{controls} = K n^S_{cases}$ controls with measured $S^{\ast}$ $(R=1)$
  </ol>
</li>
</ol>

## Algorithm for continuous biomarker \(\small\, S^{\ast}\) | Without replacement sampling
<ol start=5>
<li> For each observed data set, compute the 1-sided one-degree-of-freedom Wald test statistic for $H_0 \Leftrightarrow \{\widetilde{H}_0: \beta_{S^{\ast}} \geq 0\}$ from IPW logistic regression model that accounts for biomarker sampling design (function `tps` in R package `osDesign`)
<li> Compute power as proportion of data sets with 1-sided Wald test $p \leq \alpha/2$ for specified $\alpha$
<li> Repeat power calculation varying control:case ratio, $n_{cases}$, $n^S_{cases}$, $P^{lat}_{lowestVE}$, $\rho$
</ol>

## Illustration: `CoRpower` for continuous \(\small\, S^{\ast}\) | Without replacement sampling
- *Scenario 8:* vary $\rho$
- *Scenario 9:* vary $P_{lowestVE}^{lat}$

## *Scenario 8:* vary \(\small\, \rho \) | Continuous \(\small\, S^{\ast}\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = 32,               # n_cases
                    nAtRiskTauControls = 3585,          # n_controls
                    nAtRiskTauCasesPhase2 = 32,         # n^S_cases
                    controlCaseRatio = 5,               # n^S_controls : n^S_cases ratio
                    VEoverall = 0.75,                   # overall VE
                    risk0 = 0.034,                      # cumulative placebo risk between tau and tau_max 
                    PlatVElowest = 0.2,                 # prevalence of VE_lowest
                    VElowest = seq(0, VEoverall, len=100), # lowest VE level for true biomarker X* <= nu
                    sigma2obs = 1,                      # variance of observed biomarker S
                    rho = c(1, 0.9, 0.7, 0.5)           # protection-relevant fraction of the variance of S
                    M = 1000,                           # number of simulated clinical trials
                    alpha = 0.05,                       # two-sided Wald test Type 1 error rate
                    biomType = "continuous")            # "continuous" by default
```

```{r, echo=FALSE, cache=TRUE}
setwd("T:/vaccine/StephanieWu/CoR Power Package In Progress/Scenario9")
load("ansScen9.RData")
pwr <- pwr
```

## *Scenario 8:* vary \(\small\, \rho\) | Continuous \(\small\, S^{\ast}\), without replacement sampling {.smaller}
```{r}
pwr$power[1, c(1, 25, 50, 75, 100)]
pwr$RRc[c(1, 25, 50, 75, 100)]
pwr$VElowest[c(1, 25, 50, 75, 100)]
```

Other components: `betaLat`, `PlatVElowest`, `N`, `nCases`, `nCasesPhase2`, `VEoverall`, `alpha`, `rho`, `controlCaseRatio`

## *Scenario 8:* vary \(\small\, \rho \) | Continuous \(\small\, S^{\ast}\), without replacement sampling {.smaller}
```{r, eval=FALSE}
plotVEcurveContinuous(dataDir = "~/Scen8",                   # input directory 
                      dataFile = "pwr",                      # input file (.RData file)
                      variableName = "rho",                  # name of varying parameter
                      variableValues = c(1, 0.9, 0.7, 0.5),  # values of varying parameter
                      legendText=NULL,                       # option to specify legend text
                      risk0)                                 # placebo risk between tau and tau_max
```

## *Scenario 8:* vary \(\small\, \rho \) | Continuous \(\small\, S^{\ast}\), without replacement sampling
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"plotVEcurveCoRcontinuous_Scen9.png"))
```

## *Scenario 8:* vary \(\small\, \rho \) {.smaller}
```{r, eval=FALSE}
plotPowerContinuous(dataDir = "~/Scen8",                # input directory 
                 dataFile = "pwr",                      # input file (.RData file)
                 variableName = "rho",                  # name of varying parameter
                 variableValues = c(1, 0.9, 0.7, 0.5),  # values of varying parameter
                 legendText=NULL)                       # option to specify legend text
```

## *Scenario 8:* vary \(\small\, \rho \)
```{r, echo=FALSE, fig.align='center', out.width='70%'}
knitr::include_graphics(file.path(figDir,"powercontinuous_CoR_Scen9.png"))
```

## *Scenario 9:* vary \(\small\, P_{lowestVE}^{lat} \) | Continuous \(\small\, S^{\ast}\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = 32,               # n_cases
                    nAtRiskTauControls = 3585,          # n_controls
                    nAtRiskTauCasesPhase2 = 32,         # n^S_cases
                    controlCaseRatio = 5,               # n^S_controls : n^S_cases ratio
                    VEoverall = 0.75,                   # overall VE
                    risk0 = 0.034,                      # cumulative placebo risk between tau and tau_max 
                    PlatVElowest = 0.05,                # scalar, ie separate calls for 0.05, 0.1, 0.15, 0.2
                    VElowest = seq(0, VEoverall, len=100), # lowest VE level for true biomarker X* <= nu
                    sigma2obs = 1,                      # variance of observed biomarker S
                    rho = 0.9                           # protection-relevant fraction of the variance of S
                    M = 1000,                           # number of simulated clinical trials
                    alpha = 0.05,                       # two-sided Wald test Type 1 error rate
                    biomType = "continuous")            # "continuous" by default
```

## *Scenario 9:* vary \(\small\, P_{lowestVE}^{lat} \)
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"plotVEcurveCoRcontinuous_Scen10.png"))
```

## *Scenario 9:* vary \(\small\, P_{lowestVE}^{lat} \)
```{r, echo=FALSE, fig.align='center', out.width='70%'}
knitr::include_graphics(file.path(figDir,"powercontinuous_CoR_Scen10.png"))
```

## Bernoulli / case-cohort sampling of \(\small\, S\) (or \(\small\, S^{\ast}\))
- Bernoulli sample at baseline with sampling probability $p$
- $S$ (or $S^{\ast}$) measured at $\tau$ in
    - a subset of the sample with $Y^{\tau}=0$, and
    - all cases with $Y^{\tau}=0$
- Implications:
    - $n_{cases} = n^S_{cases}$
    - $n^S_{controls}$ replaced by $p$, i.e., the number of controls sampled into the subcohort for measurement of $S$ (or $S^{\ast}$) is a random variable

## Illustration: `CoRpower` for trichotomous \(\small\, S\) and continuous \(\small\, S^{\ast}\) | Bernoulli sampling
Trichotomous $S$ (Approach 1)

- *Scenario 10:* vary $p$

Continuous $S^{\ast}$

- *Scenario 11:* vary $p$

## *Scenario 10:* vary \(\small\, p \) (Approach 1) | Trichotomous \(\small\, S \), Bernoulli sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = 32,             # n_cases
                    nAtRiskTauControls = 3585,        # n_controls
                    nAtRiskTauCasesPhase2 = 32,       # n^S_cases
                    cohort = TRUE,                    # FALSE by default
                    p = 0.01,                         # scalar, ie separate calls for 0.01, 0.02, 0.03, 0.05
                    VEoverall = 0.75,                 # overall VE
                    risk0 = 0.034,                    # cumulative placebo risk between tau and tau_max 
                    VElat0 = seq(0, VEoverall, len=100), # grid of VE (V/P) among lower protected
                    VElat1 = rep(VEoverall, 100),     # grid of VE (V/P) among medium protected
                    Plat0 = 0.2,                      # prevalence of lower protected
                    Plat2 = 0.6,                      # prevalence of higher protected
                    P0 = 0.2,                         # probability of low biomarker response
                    P2 = 0.6,                         # probability of high biomarker response
                    sens = 0.8, spec = 0.8, FP0 = 0, FN2 = 0,
                    M = 1000,                         # number of simulated clinical trials
                    alpha = 0.05,                     # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")        # "continuous" by default
```

## *Scenario 10:* vary \(\small\, p \) (Approach 1)
```{r, echo=FALSE, fig.align='center', out.width='66%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen4.png"))
```


## *Scenario 11:* vary \(\small\, p \) | Continuous \(\small\, S^{\ast}\), Bernoulli sampling {.smaller}
```{r, eval=FALSE}
pwr <- computePower(nAtRiskTauCases = 32,             # n_cases
                    nAtRiskTauControls = 3585,        # n_controls
                    nAtRiskTauCasesPhase2 = 32,       # n^S_cases
                    cohort = TRUE,                    # FALSE by default
                    p = 0.01,                         # scalar, ie separate calls for 0.01, 0.02, 0.03, 0.05
                    VEoverall = 0.75,                 # overall VE
                    risk0 = 0.034,                    # cumulative placebo risk between tau and tau_max 
                    PlatVElowest = 0.2,               # prevalence of VE_lowest
                    VElowest = seq(0, VEoverall, len=100), # lowest VE level for true biomarker X* <= nu
                    sigma2obs = 1,                    # variance of observed biomarker S
                    rho = 0.9                         # protection-relevant fraction of the variance of S
                    M = 1000,                         # number of simulated clinical trials
                    alpha = 0.05,                     # two-sided Wald test Type 1 error rate
                    biomType = "continuous")          # "continuous" by default
```

## *Scenario 11:* vary \(\small\, p \)
```{r, echo=FALSE, fig.align='center', out.width='70%'}
knitr::include_graphics(file.path(figDir,"powercontinuous_CoR_Scen11.png"))
```

## Key R functions to design and conduct a CoR power analysis, and display analysis results
<br><br><br>
<div style="float: left; width: 33%;">
</div>
<div style="float: right; width: 67%;">
- `computeN`
- `computePower`
- `plotPowerTrinary`
- `plotRRgradVE`
- `plotPowerContinuous`
- `plotVElatContinuous`
    
</div>

##     
<br><br>
<div class="centered">
R package `CoRpower` soon to appear on CRAN
<br><br>

Currently downloadable at:

https://github.com/smwu/CoRpower
<br><br>

Implementation of Gilbert, Janes, Huang (2016, *Stat Med*)
<br><br>

Code and slide contributions:

Stephanie Wu
</div>