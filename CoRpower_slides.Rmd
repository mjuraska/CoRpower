---
title: "R Package `CoRpower`: Power and Sample Size Calculations for Correlates of Risk"
subtitle: "Based on Gilbert, Janes, Huang (2016, *Stat Med*)"
author: "Michal Juraska"
date: "September 24-26, 2018"
output: 
  ioslides_presentation: 
    widescreen: true
    transition: 0
---

```{r, include=FALSE, cache=TRUE}
library(survival)
library(osDesign)
source("T:/vaccine/StephanieWu/CoR Power Package In Progress/CoRpower/Peter_CoRpower_trinaryMODIFIED.R")

figDir <- "T:/vaccine/StephanieWu/CoR Power Package In Progress/Figures"
```

## Outline
**Power and sample size calculations:**

1. **Without replacement sampling** for retrospective case-control or 2-phase designs
     + Trichotomous biomarker
         + Dichotomous biomarker
     + Continuous biomarker
2. **Bernoulli sampling** for prospective case-cohort designs

<!-- <br>  -->
<!-- - All R code illustrated considering P2-VP8 rotavirus vaccine efficacy trial design  -->

## Set-up and notation | Without replacement sampling
- Assume a randomized vaccine vs. placebo/control vaccine efficacy trial
- $N=$ number of vaccine recipients observed to be at risk at $\tau$
- $n_{cases}$ ($n_{controls}$) $=$ number of observed cases (controls) between $\tau$ and $\tau_{\mathrm{max}}$, where cases have $\Delta Y = 1$ and controls have $\Delta (1-Y) = 1$
- $n^S_{cases}$ ($n^S_{controls}$) $=$ number of observed cases (controls) between $\tau$ and $\tau_{\mathrm{max}}$ with measured $S$ (or $S^{\ast}$)

<br>
- If calculations done at design stage, then $N$, $n_{cases}$, $n_{controls}$, $n^S_{cases}$, and $n^S_{controls}$ projected numbers

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol>
<li> Specify overall $VE$ between $\tau$ and $\tau_{\mathrm{max}}$
  <ul>
  <li> Protocol-specified design alternative or $\widehat{VE}$
  </ul>
</li>
<li> Specify $risk_0$
  <ul>
  <li> Protocol-specified placebo-group endpoint rate or $\widehat{risk}_0$
  </ul>
</li>
<li> Select a grid of $VE^{lat}_0$ values
  <ul>
  <li> E.g., ranging from $VE$ ($H_0$) to 0 (maximal $H_1$ not allowing harm by vaccination)
  </ul>
</li>
<li> Select a grid of $VE^{lat}_1 \geq VE^{lat}_0$ values
  <ul>
  <li> E.g., $VE^{lat}_1 = VE$
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=5>
<li> Specify $P^{lat}_0$ and $P^{lat}_2$, then $P^{lat}_1 = 1-P^{lat}_0-P^{lat}_2$
  <ul>
  <li> Assuming $risk^{lat}_0(x) = risk_0$,
  \[
  VE = VE^{lat}_0 P^{lat}_0 + VE^{lat}_1 P^{lat}_1 + VE^{lat}_2 P^{lat}_2
  \]
  yields $VE^{lat}_2$
  <li> If $VE^{lat}_0$ varies from $VE$ to 0, then $VE^{lat}_2$ varies from VE to $VE\, (P^{lat}_0 + P^{lat}_2)/P^{lat}_2$
  </ul>
</li>
<li> Specify $P_0$ and $P_2$, then $P_1 = 1-P_0-P_2$
  <ul>
  <li> E.g., $P_0 = P^{lat}_0$ and $P_2 = P^{lat}_2$
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=7>
<li> **Approach 1:** Specify two of the three $(Sens, FP^0, FP^1)$ and two of the three $(Spec, FN^2, FN^1)$
  <ul>
  <li> E.g., specify $Sens$ and $Spec$ and $FP^0 = FN^2 = 0$
  </ul>

**Approach 2:** Specify $\sigma^2_{obs}$ and $\rho = \sigma^2_{tr} / \sigma^2_{obs}$ and determine $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ (subsequent slides)
  <ul>
  <li> Typically, $\sigma^2_{obs} = 1$
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i">
<li> Assuming the classical measurement error model, where $X^{\ast} \sim \mathsf{N}(0,\rho\sigma^2_{obs})$, solve
\[
P^{lat}_0 = P(X^{\ast} \leq \theta_0) \quad \textrm{and} \quad P^{lat}_2 = P(X^{\ast} > \theta_2)
\]
for $\theta_0$ and $\theta_2$
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=2>
<li> Generate $B$ realizations of $X^{\ast}$ and $S^{\ast} = X^{\ast} + e$, where $e \sim \mathsf{N}(0,(1-\rho)\sigma^2_{obs})$, and $X^{\ast}$ independent of $e$
  <ul>
  <li> $B = 20000$ by default
  </ul>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=3>
<li> Using $\theta_0$ and $\theta_2$ from Step i., define
\[
\begin{align}
Spec(\phi_0) &= P(S^{\ast} \leq \phi_0 \mid X^{\ast} \leq \theta_0)\\
FN^1(\phi_0) &= P(S^{\ast} \leq \phi_0 \mid X^{\ast} \in (\theta_0,\theta_2])\\
FN^2(\phi_0) &= P(S^{\ast} \leq \phi_0 \mid X^{\ast} > \theta_2)\\
Sens(\phi_2) &= P(S^{\ast} > \phi_2 \mid X^{\ast} > \theta_2)\\
FP^1(\phi_2) &= P(S^{\ast} > \phi_2 \mid X^{\ast} \in (\theta_0,\theta_2])\\
FP^0(\phi_2) &= P(S^{\ast} > \phi_2 \mid X^{\ast} \leq \theta_0)
\end{align}
\]
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=3>
<li> Estimate $Spec(\phi_0)$ by
\[
\widehat{Spec}(\phi_0) = \frac{\#\{S^{\ast}_b \leq \phi_0, X^{\ast}_b \leq \theta_0\}}{\#\{X^{\ast}_b \leq \theta_0\}}\,,
\]
etc.
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
### **Calculation of $(Sens, Spec, FP^0, FP^1, FN^1, FN^2)$ in Approach 2**
<br>
<ol type="i" start=4>
<li> Find $\phi_0 = \phi^{\ast}_0$ and $\phi_2 = \phi^{\ast}_2$ that numerically solve
\[
\begin{align}
P_0 &= \widehat{Spec}(\phi_0)P^{lat}_0 + \widehat{FN}^1(\phi_0)P^{lat}_1 + \widehat{FN}^2(\phi_0)P^{lat}_2\\
P_2 &= \widehat{Sens}(\phi_2)P^{lat}_2 + \widehat{FP}^1(\phi_2)P^{lat}_1 + \widehat{FP}^0(\phi_2)P^{lat}_0
\end{align}
\]
and compute
\[
Spec = \widehat{Spec}(\phi^{\ast}_0),\; Sens = \widehat{Sens}(\phi^{\ast}_2),\; \textrm{etc.}
\]
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
- In Approach 2, plot
\[
RR_t \quad \textrm{vs.} \quad RR^{lat}_2\big/ RR^{lat}_0,
\]
where
\[
RR_t = \frac{\sum_{x=0}^2 RR^{lat}_x P(X=x|S=2)}{\sum_{x=0}^2 RR^{lat}_x P(X=x|S=0)}
\]
- For $\rho < 1$, $RR_t$ closer to 1 than $RR^{lat}_2\big/ RR^{lat}_0$

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=8>
<li> Simulate $M$ data sets under the true parameter values:
  <ol type="a">
  *Full data*
  <li> $N_x = N \times P^{lat}_x$
  <li> $\left(n_{cases}(0),n_{cases}(1),n_{cases}(2)\right) \sim \mathsf{Mult}(n_{cases},(p_0,p_1,p_2))$, where $p_k=P(X=k|Y=1,Y^{\tau}=0,Z=1)$
  <li> For each of the $N_x$ subjects, generate $S_i$ by a draw from $\mathsf{Mult}(1,(p_0,p_1,p_2))$, where $p_k=P(S=k|X=x)$ </li>
  *Observed data*
  <li> Sample without replacement $n^S_{cases}$ and $n^S_{controls} = K n^S_{cases}$ controls with measured $S$ $(R=1)$, i.e., the control:case ratio is not fixed within subgroup $X=x$
  </ol>
</li>
</ol>

## Algorithm for trichotomous biomarker \(\small\, S\) | Without replacement sampling
<ol start=9>
<li> For each observed data set, compute the 1-sided one-degree-of-freedom Wald test statistic for $H_0 \Leftrightarrow \{\widetilde{H}_0: \beta_S \geq 0\}$ from IPW logistic regression model that accounts for biomarker sampling design (function `tps` in R package `osDesign`)
  <ul>
  <li> Alternatively, use the generalized two-degree-of-freedom Wald test
  </ul>
</li>
<li> Compute power as proportion of data sets with 1-sided Wald test $p \leq \alpha/2$ for specified $\alpha$
<li> Repeat power calculation varying control:case ratio, $n_{cases}$, $n^S_{cases}$, $(P^{lat}_0, P^{lat}_2, P_0, P_2)$, $(Sens, Spec)$, $\rho$
</ol>

## Illustration: hypothetical randomized placebo-controlled VE trial
### **Trial design**
- $N_{rand} = 4,100$ participants randomized to each of the vaccine and placebo group and followed for $\tau_{\mathrm{max}}=$ 24 months
- Samples for measurement of $S$ at $\tau=$ 3.5 months stored in all vaccine recipients
- Cumulative endpoint rate between $\tau$ and $\tau_{\mathrm{max}}$ in placebo group $=3.4\%$ $(=risk_0)$
- $VE_{\tau-\tau_{\mathrm{max}}}=75\%$, $\quad VE_{0-\tau}=VE_{\tau-\tau_{\mathrm{max}}}/2$
- Cumulative dropout rate between 0 and $\tau_{\mathrm{max}}=10\%$

## Illustration: calculation of input parameters
Assuming the standard survival analysis framework,

- $N = N_{rand} \times P(T>\tau, C>\tau \mid Z=1) \approx 4,023$
- $n_{cases} = N \times P(T\leq \tau_{\mathrm{max}}, T\leq C \mid T>\tau, C>\tau, Z=1) \approx 32$
- $n^S_{cases} = n_{cases}$
- $n^S_{controls} = K n^S_{cases}$

## Illustration: `CoRpower` for trichotomous \(\small\, S\) | Without replacement sampling
**Approach 1** $(Sens, Spec, FP^0, FN^2$ specified$)$

- *Scenario 1:* vary control:case ratio
- *Scenario 2:* vary $Sens$, $Spec$
- *Scenario 3:* vary $P_0^{lat}$, $P_2^{lat}$, $P_0$, $P_2$

**Approach 2** $(\sigma^2_{obs}$ and $\rho$ specified$)$

- *Scenario 4:* vary $\rho$
- *Scenario 5:* vary $P_0^{lat}$, $P_2^{lat}$, $P_0$, $P_2$
- *Scenario 6:* vary $n_{cases}$

## *Scenario 1:* vary control:case ratio (Approach 1) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
library(CoRpower)
pwr <- computepower(nAtRiskTauCases = 32,                # n_cases
                    nAtRiskTauControls = 3991,           # n_controls
                    nAtRiskTauCasesPhase2 = 32,          # n^S_cases
                    controlCaseRatio = 5,                # scalar, ie separate 'computepower' calls for 5, 3, 1
                    VEoverall = 0.25,                    # overall VE
                    risk0 = 0.034,                       # cumulative placebo risk between tau and tau_max 
                    VElat0 = seq(0, VEoverall, len=100), # grid of VE (V/P) among lower protected
                    VElat1 = rep(VEoverall, 100),        # grid of VE (V/P) among medium protected
                    Plat0 = 0.2,                         # prevalence of lower protected
                    Plat2 = 0.6,                         # prevalence of higher protected
                    P0 = 0.2,                            # probability of low biomarker response
                    P2 = 0.6,                            # probability of high biomarker response
                    Sens = 0.8, Spec = 0.8, FP0 = 0, FN2 = 0,
                    M = 1000,                            # number of simulated clinical trials
                    alpha = 0.05,                        # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")           # "continuous" by default
```


```{r, include=FALSE, cache=TRUE}
setwd("T:/vaccine/StephanieWu/CoR Power Package In Progress/Scenario1/K1")
powerstrinary <- matrix(scan('powerstrinary0.60.25.dat'),nrow=1, byrow=TRUE)
risk1_0 <- matrix(scan('vaccineriskslo0.60.25.dat'), nrow=1, byrow=TRUE)
risk1_2 <- matrix(scan('vaccineriskshi0.60.25.dat'), nrow=1, byrow=TRUE)
RRt <- risk1_2/risk1_0
RRlat2 <- RRlat2 <- scan('RRlat2.dat')
```

## *Scenario 1:* vary control:case ratio (Approach 1) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
Output list for `controlCaseRatio = 5`:
```{r, eval=FALSE}
pwr$power[1, c(1, 25, 50, 75, 100)]
```
```{r, echo=FALSE}
powerstrinary[1, c(1,25,50,75,100)]
```
```{r, eval=FALSE}
pwr$RRt[1, c(1, 25, 50, 75, 100)]
```
```{r, echo=FALSE}
RRt[1, c(1,25,50,75,100)]
```
```{r, eval=FALSE}
pwr$RRlat2[c(1, 25, 50, 75, 100)]
```
```{r, echo=FALSE} 
RRlat2[c(1,25,50,75,100)]
```
Other components: `risk1_2`, `risk1_0`, `RRlat0`, `Plat2`, `Plat0`, `P2`, `P0`, `trinaryalpha`, `trinarybeta`, `Sens`, `Spec`, `FP0`, `FN2`, `N`, `nCases`, `nCasesPhase2`, `VEoverall`, `alpha`, `rhos`, `controlCaseRatio`

## *Scenario 1:* vary control:case ratio (Approach 1)
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen1.png"))
```

## *Scenario 2:* vary \(\small\, Sens\) and \(\small\, Spec\) (Approach 1) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computepower(nAtRiskTauCases = 32,             # n_cases
                    nAtRiskTauControls = 3991,        # n_controls
                    nAtRiskTauCasesPhase2 = 32,       # n^S_cases
                    controlCaseRatio = 5,             # n^S_controls : n^S_cases ratio
                    VEoverall = 0.75,                 # overall VE
                    risk0 = 0.029,                    # cumulative placebo risk between tau and tau_max 
                    RRlat0 = seq(1, 0.25, len = 100), # grid of relative risk (V/P) among lower protected
                    RRlat1 = rep(0.25, 100),          # grid of relative risk (V/P) among medium protected
                    Plat0 = 0.2,                      # prevalence of lower protected
                    Plat2 = 0.6,                      # prevalence of higher protected
                    P0 = 0.2,                         # probability of low biomarker response
                    P2 = 0.6,                         # probability of high biomarker response
                    Sens = c(1, 0.9, 0.8, 0.7), Spec = c(1, 0.9, 0.8, 0.7), 
                    FP0 = 0, FN2 = 0,
                    M = 1000,                         # number of simulated clinical trials
                    alpha = 0.05,                     # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")        # "continuous" by default
```

## *Scenario 2:* vary \(\small\, Sens\) and \(\small\, Spec\) (Approach 1)
```{r, echo=FALSE, fig.align='center', out.width='67%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen3.png"))
```

## *Scenario 3:* vary \(\small\, P^{lat}_0, P^{lat}_2, P_0, P_2\) (Approach 1) | Trichotomous \(\small\, S\), without replacement sampling {.smaller}
```{r, eval=FALSE}
pwr <- computepower(nAtRiskTauCases = 32,             # n_cases
                    nAtRiskTauControls = 3991,        # n_controls
                    nAtRiskTauCasesPhase2 = 32,       # n^S_cases
                    controlCaseRatio = 5,             # n^S_controls : n^S_cases ratio
                    RRoverall = 0.25,                 # 1 - overall VE
                    risk0 = 0.029,                    # cumulative placebo risk between tau and tau_max 
                    RRlat0 = seq(1, 0.25, len = 100), # grid of relative risk (V/P) among lower protected
                    RRlat1 = rep(0.25, 100),          # grid of relative risk (V/P) among medium protected
                    Plat0 = 0.05,                     # scalar, ie separate calls for 0.05, 0.1, 0.15, 0.2
                    Plat2 = 0.15,                     # scalar, ie separate calls for 0.15, 0.3, 0.45, 0.6
                    P0 = 0.05,                        # scalar, ie separate calls for 0.05, 0.1, 0.15, 0.2
                    P2 = 0.15,                        # scalar, ie separate calls for 0.15, 0.3, 0.45, 0.6
                    Sens = 0.8, Spec = 0.8, FP0 = 0, FN2 = 0,
                    M = 1000,                         # number of simulated clinical trials
                    alpha = 0.05,                     # two-sided Wald test Type 1 error rate
                    biomType = "trichotomous")        # "continuous" by default
```

## *Scenario 3:* vary \(\small\, P^{lat}_0, P^{lat}_2, P_0, P_2\) (Approach 1)
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen2.png"))
```

## *Scenario 4:* Trichotomous, approach 2 | Vary \(\small\, \rho \) {.smaller}
```{r, eval=FALSE}
ans <- computepower(numAtRiskTauCases=31, 
                    numAtRiskTauCasesPhase2=31, 
                    numAtRiskTauControls=4485,
                    risk0=0.034, 
                    RRoverall=0.25, 
                    Plat0=0.2, P0=0.2, 
                    Plat2=0.6, P2=0.6, 
                    RRlat0=seq(1, 25, len=100), RRlat1=rep(0.25, 100), 
                    PlatVElowest=0, VElowestvect=NULL,
                    controlCaseRatio=5, 
                    M=1000, 
                    alpha=0.05, 
                    sigma2obs=1,  # variance of observed biomarker
                    ### <b>
                    rhos=c(1, 0.9, 0.7, 0.5),  # fraction of relevant variability in the observed biomarker
                    ### </b>
                    biomType="trichotomous")
```

```{r, echo=FALSE}
setwd("T:/vaccine/StephanieWu/CoR Power Package In Progress/Scenario5")
powerstrinary <- matrix(scan('powerstrinary0.60.25.dat'),nrow=4, byrow=T)
risk1_0 <- matrix(scan('vaccineriskslo0.60.25.dat'), nrow=4, byrow=T)
risk1_2 <- matrix(scan('vaccineriskshi0.60.25.dat'), nrow=4, byrow=T)
RRt <- risk1_2/risk1_0
RRlat2 <- RRlat2 <- scan('RRlat2.dat')
```

## Scenario 4 Output | List of 23 elements: {.smaller}

<div style="float: left; width: 70%;">
<ul>
  <li>`powerstrinary`
```{r, echo=FALSE}
powerstrinary[,1:5]
```
  <li>CoR effect size `RRt`
```{r, echo=FALSE}
RRt[,1:5]
```
  <li>`RRlat2` 
```{r, echo=FALSE} 
RRlat2[1:5]
```
</div>
<div style="float: right; width: 30%;">
<br>
<ul>
  <li> `risk1_2`, `risk1_0`, 
  <br>
  <li> `RRlat0`, `VEoverall`,
  <br>
  <li> `Plat2`, `Plat0`, `P2`, `P0`, 
  <br>
  <li> `trinaryalpha`, `trinarybeta`, 
  <br>
  <li> `Sens`, `Spec`, `FP0`, `FN2`, 
  <br>
  <li> `N`, `nCases`, `nCasesPhase2`, 
  <br>
  <li> `alpha`, `rhos`, `controlCaseRatio`
</ul>

## Scenario 4 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen5.png"))
```

## Scenario 4 Table
```{r, echo=FALSE, fig.align='center', out.width='90%'}
knitr::include_graphics(file.path(figDir,"Scen5Table1.png"))
```

## *Scenario 5:* Trichotomous, approach 2 | Vary \(\small\, P^{lat}_0, P_0, P^{lat}_2, P_2\) {.smaller}
```{r, eval=FALSE}
ans <- computepower(numAtRiskTauCases=31, 
                    numAtRiskTauCasesPhase2=31, 
                    numAtRiskTauControls=4485,
                    risk0=0.034, 
                    RRoverall=0.25, 
                    ### <b>
                    Plat0=0.05*, P0=0.05*, 
                    Plat2=0.15*, P2=0.15*, 
                    ### </b>
                    RRlat0=seq(1, 25, len=100), RRlat1=rep(0.25, 100), 
                    PlatVElowest=0, VElowestvect=NULL,  
                    controlCaseRatio=5, 
                    M=1000, 
                    alpha=0.05, 
                    sigma2obs=1,
                    rhos=0.9,
                    biomType="trichotomous")
```

*$P^{lat}_0$ and $P_0$ take on 0.05, 0.1, 0.15, and 0.2, and $P^{lat}_2$ and $P_2$ take on 0.15, 0.3, 0.45, and 0.6

## Scenario 5 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen6.png"))
```

## Scenario 5 Table
```{r, echo=FALSE, fig.align='center', out.width='90%', out.height='30%'}
knitr::include_graphics(file.path(figDir,"Scen6Table1.png"))
```


## *Scenario 6:* Trichotomous, approach 2 | Vary \(\small\, n_{cases}\) {.smaller}
```{r, eval=FALSE}
ans <- computepower(### <b>
                    numAtRiskTauCases=c(25, 31, 35, 40), 
                    numAtRiskTauCasesPhase2=c(25, 31, 35, 40), 
                    numAtRiskTauControls=c(125, 155, 175, 200),
                    ### </b>
                    risk0=0.034, 
                    RRoverall=0.25, 
                    Plat0=0.2, P0=0.2, 
                    Plat2=0.6, P2=0.6, 
                    RRlat0=seq(1, 25, len=100), RRlat1=rep(0.25, 100), 
                    PlatVElowest=0, VElowestvect=NULL,  
                    controlCaseRatio=5, 
                    M=1000, 
                    alpha=0.05, 
                    sigma2obs=1,
                    rhos=0.9,
                    biomType="trichotomous")
```

## Scenario 6 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen7.png"))
```

## Scenario 6 Table
```{r, echo=FALSE, fig.align='center', out.width='90%'}
knitr::include_graphics(file.path(figDir,"Scen7Table1.png"))
```



## Illustration: `CoRpower` for binary \(\small\, S\) | Without replacement sampling
Achieved by selecting $P_0^{lat}$, $P_2^{lat}$, $P_0$, $P_2$ such that
\[
\begin{align}
P_0^{lat} + P_2^{lat} &= 1\\
P_0 + P_2 &= 1
\end{align}
\]

<br>
**Approach 2** $(\sigma^2_{obs}$ and $\rho$ specified$)$

- *Scenario 7:* vary $n_{cases}$

## *Scenario 7:* Binary, approach 2 | Vary \(\small\, n_{cases}\) {.smaller}
```{r, eval=FALSE}
ans <- computepower(### <b>
                    numAtRiskTauCases=c(25, 31, 35, 40), 
                    numAtRiskTauCasesPhase2=c(25, 31, 35, 40), 
                    numAtRiskTauControls=c(125, 155, 175, 200),
                    ### </b>
                    risk0=0.034, 
                    RRoverall=0.25, 
                    Plat0=0.2, P0=0.2, 
                    Plat2=0.8, P2=0.8, 
                    RRlat0=seq(1, 25, len=100), RRlat1=rep(0.25, 100), 
                    PlatVElowest=0, VElowestvect=NULL,  
                    controlCaseRatio=5, 
                    M=1000, 
                    alpha=0.05, 
                    sigma2obs=1,
                    rhos=0.9,
                    biomType="trichotomous")
```

## Scenario 7 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen8.png"))
```

## Scenario 7 Table
```{r, echo=FALSE, fig.align='center', out.width='90%'}
knitr::include_graphics(file.path(figDir,"Scen8Table1.png"))
```


## Algorithm for continuous biomarker \(\small\, S^{\ast}\) | Without replacement sampling
<ol>
<li> Specify overall $VE$ between $\tau$ and $\tau_{\mathrm{max}}$
  <ul>
  <li> Protocol-specified design alternative or $\widehat{VE}$
  </ul>
</li>
<li> Specify $risk_0$
  <ul>
  <li> Protocol-specified placebo-group endpoint rate or $\widehat{risk}_0$
  </ul>
</li>
</ol>

## Algorithm for continuous biomarker \(\small\, S^{\ast}\) | Without replacement sampling
<ol start=3>
<li> Specify $P^{lat}_{lowestVE}$, $\rho$, and a grid of $VE_{lowest}$ values (e.g., ranging from $VE$ to 0)
  <ul>
  <li> Fixed $(VE, risk_0, P^{lat}_{lowestVE}, VE_{lowest}, \rho)$ and
  \[
  \begin{align}
  VE^{lat}_{x^{\ast}} &= VE_{lowest},\quad x^{\ast} \leq \nu\\
  VE^{lat}_{x^{\ast}} &= 1-\frac{\mathop{\mathrm{logit}}^{-1}\!(\alpha^{lat}+\beta^{lat}x^{\ast})}{risk_0}\,,\quad x^{\ast} \geq \nu
  \end{align}
  \]
  yield $\alpha^{lat}$ and $\beta^{lat}$
  <li> Plot $VE^{lat}_{x^{\ast}}$ vs. $x^{\ast}$ and calculate the pertaining CoR effect size $\exp(\beta^{lat})$ for each level of $VE_{lowest}$
  </ul>
</li>
</ol>

## Algorithm for continuous biomarker \(\small\, S^{\ast}\) | Without replacement sampling
<ol start=4>
<li> Simulate $M$ data sets under the true parameter values:
  <ol type="a">
  *Full data*
  <li> Sample $X^{\ast}$ for $n_{cases}$ cases from $f_{X^{\ast}}(x^{\ast}|Y=1,Y^{\tau}=0,Z=1)$ using Bayes rule
  <li> Sample $X^{\ast}$ for $n_{controls}$ controls from $f_{X^{\ast}}(x^{\ast}|Y=0,Y^{\tau}=0,Z=1)$ using Bayes rule
  <br>
  - How? Use a fine grid of $\widetilde{x}^{\ast}$ values and then 
  <br>
  $\;\;$`sample(`$\widetilde{x}^{\ast}$, `prob=`$f_{X^{\ast}}(\widetilde{x}^{\ast}|Y=\cdot,Y^{\tau}=0,Z=1)$, `replace=TRUE)`
  <li> Sample $S^{\ast}$ following $S^{\ast} = X^{\ast} + e$ </li>
  *Observed data*
  <li> Sample without replacement $n^S_{cases}$ and $n^S_{controls} = K n^S_{cases}$ controls with measured $S^{\ast}$ $(R=1)$
  </ol>
</li>
</ol>

## Algorithm for continuous biomarker \(\small\, S^{\ast}\) | Without replacement sampling
<ol start=5>
<li> For each observed data set, compute the 1-sided one-degree-of-freedom Wald test statistic for $H_0 \Leftrightarrow \{\widetilde{H}_0: \beta_{S^{\ast}} \geq 0\}$ from IPW logistic regression model that accounts for biomarker sampling design (function `tps` in R package `osDesign`)
<li> Compute power as proportion of data sets with 1-sided Wald test $p \leq \alpha/2$ for specified $\alpha$
<li> Repeat power calculation varying control:case ratio, $n_{cases}$, $n^S_{cases}$, $P^{lat}_{lowestVE}$, $\rho$
</ol>

## Illustration: `CoRpower` for continuous \(\small\, S^{\ast}\) | Without replacement sampling
- *Scenario 8:* vary $\rho$
- *Scenario 9:* vary $P_{lowestVE}^{lat}$


## *Scenario 8:* Continuous | Vary \(\small\, \rho\) {.smaller}
```{r, eval=FALSE}
ans <- computepower(numAtRiskTauCases=31, 
                    numAtRiskTauCasesPhase2=31, 
                    numAtRiskTauControls=4485,
                    risk0=0.034, 
                    RRoverall=0.25, 
                    PlatVElowest=0.2,  # prevalence of VE_lowest
                    VElowest=seq(0, 1-RRoverall, len=100),  # lowest VE level for true biomarker X* <= nu
                    controlCaseRatio=5, 
                    M=1000, 
                    alpha=0.05, 
                    sigma2obs=1,
                    ### <b>
                    rhos=c(1, 0.9, 0.7, 0.5),
                    ### </b>
                    biomType="continuous")
```


```{r, echo=FALSE}
setwd("T:/vaccine/StephanieWu/CoR Power Package In Progress/Scenario9")
powerscont <- matrix(scan('powerscont5.dat'),nrow=4, byrow=T)
RRc <- scan('RRs.dat')
VElowestvect <- scan('VElowestvect.dat')
```

## Scenario 8 Output | List of 13 elements: {.smaller}
<ul>
  <li> `powerstrinary`
```{r, echo=FALSE}
powerstrinary[,1:7]
```
  <li> CoR effect size `RRc`
```{r, echo=FALSE}
RRc[1:5]
```
  <li> `VElowestvect` 
```{r, echo=FALSE} 
VElowestvect[1:5]
```
  <li> `truebetas`, `PlatVElowest`, `N`, `nCases`, `nCasesPhase2`, `VEoverall`, `alpha`, `rhos`, `controlCaseRatio`
</ul>


## Scenario 8 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powercontinuous_CoR_Scen9.png"))
```

## Scenario 8 Figures 
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"plotVEcurveCoRcontinuous_Scen9.png"))
```

## *Scenario 9:* Continuous| Vary \(\small\, P_{lowestVE}^{lat} \) {.smaller}
```{r, eval=FALSE}
ans <- computepower(numAtRiskTauCases=31, 
                    numAtRiskTauCasesPhase2=31, 
                    numAtRiskTauControls=4485,
                    risk0=0.034, 
                    RRoverall=0.25, 
                    ### <b>
                    PlatVElowest=0.05*, 
                    ### </b>
                    VElowestvect=seq(0, 1-RRoverall, len=100),  
                    controlCaseRatio=5, 
                    M=1000, 
                    alpha=0.05, 
                    sigma2obs=1,
                    rhos=0.9,
                    biomType="continuous")
```
*$P_{lowestVE}^{lat}$ takes on 0.05, 0.1, 0.15, and 0.2

## Scenario 9 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powercontinuous_CoR_Scen10.png"))
```

## Scenario 9 Figures 
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"plotVEcurveCoRcontinuous_Scen10.png"))
```

## Bernoulli / case-cohort sampling of \(\small\, S\) (or \(\small\, S^{\ast}\))
- Bernoulli sample at baseline with sampling probability $p$
- $S$ (or $S^{\ast}$) measured at $\tau$ in
    - a subset of the sample with $Y^{\tau}=0$, and
    - all cases with $Y^{\tau}=0$
- Implications:
    - $n_{cases} = n^S_{cases}$
    - $n^S_{controls}$ replaced by $p$, i.e., the number of controls sampled into the subcohort for measurement of $S$ (or $S^{\ast}$) is a random variable

## Illustration: `CoRpower` for trichotomous \(\small\, S\) and continuous \(\small\, S^{\ast}\) | Bernoulli sampling
Trichotomous $S$

- *Scenario 10:* vary $p$

Continuous $S^{\ast}$

- *Scenario 11:* vary $p$

## *Scenario 10:* Trichotomous, approach 1 | Vary cohort sampling probability, p {.smaller}
```{r, eval=FALSE}
ans <- computepower(numAtRiskTauCases=31, 
                    numAtRiskTauCasesPhase2=31, 
                    numAtRiskTauControls=4485,
                    risk0=0.034, 
                    RRoverall=0.25, 
                    Plat0=0.2, P0=0.2, 
                    Plat2=0.6, P2=0.6, 
                    RRlat0=seq(1, 25, len=100), RRlat1=rep(0.25, 100), 
                    PlatVElowest=0, VElowestvect=NULL,
                    M=1000, 
                    alpha=0.05, 
                    Spec=1, Sens=1, FP0=0 FN2=0, 
                    biomType="trichotomous", 
                    cohort=TRUE, 
                    ### <b>
                    p=0.01*)
                    ### </b>
                    
```

*$p$ takes on 0.01, 0.02, 0.03, and 0.05

## Scenario 10 Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powertrinary_CoR_Scen4.png"))
```


## *Scenario 11:* Continuous | Vary cohort sampling probabiliy, p {.smaller}
```{r, eval=FALSE}
ans <- computepower(numAtRiskTauCases=31, 
                    numAtRiskTauCasesPhase2=31, 
                    numAtRiskTauControls=4485,
                    risk0=0.034, 
                    RRoverall=0.25, 
                    PlatVElowest=0.05, 
                    VElowestvect=seq(0, 1-RRoverall, len=100),  
                    M=1000, 
                    alpha=0.05, 
                    sigma2obs=1,
                    rhos=0.9,
                    biomType="continuous",
                    cohort=TRUE, 
                    ### <b>
                    p=0.01*)
                    ### </b>
```
*$p$ takes on 0.01, 0.02, 0.03, 0.05

## *Scenario 11* Figures
```{r, echo=FALSE, fig.align='center', out.width='65%'}
knitr::include_graphics(file.path(figDir,"powercontinuous_CoR_Scen11.png"))
```
